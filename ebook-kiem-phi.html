---
layout: null
permalink: /ebook-kiem-phi.html
---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ebook - Kiếm Phi Vạn Nhân Địch</title>
    <link href="https://fonts.googleapis.com/css2?family=Niramit:wght@400;500&family=Times+New+Roman&family=Bodoni+Moda&family=Bungee&display=swap" rel="stylesheet">
    <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css' rel='stylesheet'/>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js'></script>

    <style>
        /* === 1. CẤU HÌNH IN ẤN CƠ BẢN === */
        @page { size: A4; margin: 2cm; }
        html { scroll-behavior: smooth; }
        body {
            font-family: "Times New Roman", serif; font-size: 13pt; line-height: 1.5;
            color: #000; background: #fff; max-width: 210mm; margin: 0 auto; padding: 20px;
        }

        /* === 2. ĐỊNH DẠNG CÁC KHUNG GHI CHÚ (LẤY TỪ STYLE.CSS) === */
        
        /* Khung Editor */
        .khung-ghi-chu {
            background-color: #F8F7F7; border: 1px solid #ddd; border-radius: 8px;
            width: 90%; padding: 10px 20px; margin: 20px auto; box-sizing: border-box;
            page-break-inside: avoid; /* Không bị cắt đôi khi sang trang */
        }
        .khung-ghi-chu .tieu-de-editor { text-align: center; font-weight: bold; margin: 5px 0 15px 0; }
        
        /* Khung Tác Giả */
        .khung-tac-gia {
            background-color: #fdf5e6; border-left: 5px solid #a0522d; border-radius: 0 8px 8px 0;
            width: 90%; padding: 10px 20px; margin: 25px auto; box-sizing: border-box;
            color: #444; page-break-inside: avoid;
        }
        .khung-tac-gia .tieu-de-tac-gia {
            text-align: left; font-weight: bold; font-family: 'Bodoni Moda', serif;
            font-size: 110%; margin: 0 0 10px 0; color: #a0522d;
        }

        /* Hiệu ứng chữ màu (Gradient Text) */
        .color-change-effect {
            font-weight: bold;
            background: linear-gradient(to right, #f0c34d, #d8a011, #b6860a, #d8a011, #f0c34d);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; color: #d8a011; /* Màu dự phòng khi in */
        }

        /* === 3. CẤU TRÚC EBOOK === */
        /* Trang bìa */
        .ebook-cover {
            text-align: center; page-break-after: always; display: flex; flex-direction: column;
            justify-content: center; height: 90vh; border: 5px double #000; padding: 20px;
        }
        .ebook-title { font-size: 32pt; font-weight: bold; margin-bottom: 10px; text-transform: uppercase;}
        .ebook-author { font-size: 18pt; font-style: italic; margin-bottom: 30px; }
        .ebook-cover img { max-width: 300px; margin: 20px auto; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }

        /* Mục lục */
        .ebook-toc { page-break-after: always; }
        .ebook-toc h2 { text-align: center; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 10px;}
        .ebook-toc ul { list-style: none; padding: 0; }
        .ebook-toc li { margin-bottom: 8px; border-bottom: 1px dotted #ccc; display: flex; justify-content: space-between; }
        .ebook-toc a { text-decoration: none; color: #000; font-weight: bold; width: 100%; }

        /* Nội dung chương */
        .chapter-container { page-break-after: always; margin-top: 30px; }
        .chapter-title {
            font-size: 24pt; font-weight: bold; text-align: center;
            margin-bottom: 40px; margin-top: 50px; text-transform: uppercase;
        }
        .post-body { text-align: justify; }
        .post-body p { margin-bottom: 15px; text-indent: 2em; }
        .post-body img { max-width: 80%; height: auto; display: block; margin: 15px auto; }

        /* === 4. CHÚ THÍCH LIÊN KẾT (FIXED) === */
        .note-ref { 
            font-size: 0.8em; vertical-align: super; font-weight: bold; 
            color: #0056b3; text-decoration: none; cursor: pointer; margin-left: 2px;
        }
        .chapter-notes { 
            margin-top: 50px; padding-top: 20px; border-top: 1px solid #000; 
            font-size: 11pt; page-break-inside: avoid; 
        }
        .chapter-notes h4 { margin: 0 0 15px 0; font-style: italic; font-weight: bold; }
        .notes-list { list-style: none; padding: 0; }
        .notes-list li { margin-bottom: 12px; text-align: justify; display: block; } 
        .notes-list img { max-width: 50% !important; border: 1px solid #ddd; display: block; margin: 5px 0; }
        
        /* Số thứ tự ở đầu dòng chú thích (Nút quay lại) */
        .back-link-number {
            font-weight: bold; color: #0056b3; text-decoration: none;
            margin-right: 5px; cursor: pointer;
        }
        .back-link-number:hover { text-decoration: underline; color: #d63384; }

        /* Ẩn rác */
        .post-body .tooltip .tooltiptext, .post-body iframe { display: none !important; }

        /* Loading & UI */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #e3c9bf; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .print-btn-container {
            position: fixed; top: 20px; right: 20px; background: #e3c9bf; padding: 15px 30px;
            border-radius: 50px; cursor: pointer; color: #000; font-weight: bold; z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .print-btn-container:hover { transform: scale(1.05); }
        @media print { .print-btn-container, #loading-screen { display: none !important; } }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader"></div>
        <h2 id="loading-text" style="margin-top: 20px; font-family: sans-serif;">Đang tải sách...</h2>
    </div>

    <div class="print-btn-container" onclick="window.print()">
        <i class="fas fa-file-pdf"></i> TẢI PDF / IN SÁCH
    </div>

    <div class="ebook-cover">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgp4aMzGeu8eFVVpxXyevERiCnj7vTcvDVdMEkSAcindRlOkgICyPlAGdZhnXtw0JX3qGZyOKCH_OJpzANaLmFg7Lje3ZyHN1OeI_IwsFsN44Q0eMn_8lE6Mzi6oaGv8v0Q1bw0XSY0_k09jSn2t3p4CYizCwccoBulP1sYMF2xnpt7Wn5aK77NxCDw8XM/s400/359086254-256-k306504.jpg" />
        <div class="ebook-title">KIẾM PHI VẠN NHÂN ĐỊCH</div>
        <div class="ebook-author">Tác giả: Cơ Giới Điểu | Editor: Mẫn Nhược</div>
        <div style="margin-top: 20px; font-size: 14pt;">CP: Triệu Mẫn x Chu Chỉ Nhược (Ỷ Thiên Đồ Long Ký)</div>
        <div style="margin-top: auto; font-size: 12pt;">Ebook cập nhật tự động từ Nửa Bước Thành Thơ</div>
    </div>

    <div class="ebook-toc">
        <h2>Mục lục</h2>
        <ul id="toc-list"></ul>
    </div>

    <div id="ebook-content"></div>

    <script>
        $(document).ready(function() {
            
            // CẤU HÌNH LINK GỐC
            var tocUrl = "/stories/kiem-phi-van-nhan-dich.html"; 

            console.log("Bắt đầu lấy dữ liệu từ: " + tocUrl);
            var linksToFetch = [];

            // BƯỚC 1: Lấy mục lục
            $('<div>').load(tocUrl + ' #chapter-list-container', function(response, status, xhr) {
                if (status == "error") {
                    $('#loading-text').text("Lỗi! Không tìm thấy trang mục lục gốc.");
                    return;
                }
                $(this).find('a').each(function() {
                    var href = $(this).attr('href');
                    var text = $(this).text();
                    if(href && !href.includes('LINK-CHƯƠNG')) {
                        linksToFetch.push({ url: href, title: text });
                    }
                });

                if(linksToFetch.length === 0) {
                    $('#loading-text').text("Chưa có chương nào."); return;
                }

                $('#loading-text').text("Tìm thấy " + linksToFetch.length + " chương. Đang tải...");
                loadChaptersRecursively(0);
            });

            // BƯỚC 2: Tải nội dung
            function loadChaptersRecursively(index) {
                if (index >= linksToFetch.length) {
                    $('#loading-screen').fadeOut();
                    processLinkedNotes();
                    cleanUpContent();
                    return;
                }

                var chapter = linksToFetch[index];
                $('#loading-text').text("Đang tải: " + chapter.title + " (" + (index+1) + "/" + linksToFetch.length + ")");

                var chapterId = "chap-" + index;
                var $chapterDiv = $('<div class="chapter-container" id="' + chapterId + '"></div>');
                
                $('<div>').load(chapter.url + ' .post-body', function(response, status, xhr) {
                    if (status == "error") {
                        $chapterDiv.html('<h1>' + chapter.title + '</h1><p>[Lỗi tải chương]</p>');
                    } else {
                        // Lấy nội dung
                        var content = $(this).find('.post-body').html();
                        
                        // Kiểm tra nếu không lấy được nội dung .post-body
                        if (!content || content.trim() === "") {
                             // Thử lấy entry-content (dự phòng)
                             content = $(this).find('.entry-content').html();
                        }

                        $chapterDiv.append('<h1 class="chapter-title">' + chapter.title + '</h1>');
                        $chapterDiv.append('<div class="post-body">' + content + '</div>');
                        
                        // Thêm khung chú thích
                        $chapterDiv.append('<div class="chapter-notes" style="display:none;"><h4>Chú thích chương này:</h4><ul class="notes-list"></ul></div>');
                    }

                    $('#ebook-content').append($chapterDiv);
                    $('#toc-list').append('<li><a href="#' + chapterId + '">' + chapter.title + '</a></li>');
                    loadChaptersRecursively(index + 1);
                });
            }

            // BƯỚC 3: Xử lý chú thích (LIÊN KẾT 2 CHIỀU - SỐ ĐẦU DÒNG)
            function processLinkedNotes() {
                $('.chapter-container').each(function(chapterIndex) {
                    var $chapter = $(this);
                    var $notesContainer = $chapter.find('.chapter-notes');
                    var $notesList = $chapter.find('.notes-list');
                    var noteCount = 0;
                    var chapterId = $chapter.attr('id');

                    $chapter.find('.tooltip').each(function(noteIndex) {
                        noteCount++;
                        var $tooltip = $(this);
                        var contentHtml = $tooltip.find('.tooltiptext').html();
                        
                        var refId = 'ref-' + chapterId + '-' + noteCount;
                        var noteId = 'note-' + chapterId + '-' + noteCount;
                        
                        // Tạo số mũ trong văn bản
                        var $refLink = $('<a href="#' + noteId + '" id="' + refId + '" class="note-ref">[' + noteCount + ']</a>');
                        $tooltip.after($refLink);
                        
                        // Tạo dòng chú thích với số đầu dòng là link quay lại
                        var noteItemHtml = '<li id="' + noteId + '">' + 
                                           '<a href="#' + refId + '" class="back-link-number" title="Quay lại vị trí đọc">[' + noteCount + ']</a> ' +
                                           contentHtml + 
                                           '</li>';
                        $notesList.append(noteItemHtml);

                        $tooltip.hide();
                    });

                    if (noteCount > 0) {
                        $notesContainer.show();
                    }
                });
            }

            // BƯỚC 4: Dọn dẹp rác (ĐÃ SỬA LỖI MẤT NỘI DUNG)
            function cleanUpContent() {
                // Xóa dòng link điều hướng (Chương trước/sau)
                // CHỈ XÓA nếu dòng đó NGẮN (dưới 200 ký tự) để tránh xóa nhầm nội dung truyện
                $('.post-body p, .post-body div').each(function() {
                    var text = $(this).text().toLowerCase();
                    var htmlLength = $(this).html().length;

                    // Điều kiện: Có chữ "chương trước/sau/mục lục" VÀ độ dài ngắn
                    if ((text.includes("chương trước") || text.includes("chương sau") || text.includes("mục lục")) && text.length < 200) {
                        $(this).remove();
                    }
                    
                    // Xóa các dòng chống trộm/re-up
                    if (text.includes("đọc tại") || text.includes("re-up")) {
                        $(this).remove();
                    }
                });

                // Xóa các thẻ link (a) điều hướng lẻ loi
                $('.post-body a').each(function() {
                    var text = $(this).text().toLowerCase();
                    if(text.includes('chương trước') || text.includes('chương sau') || text.includes('mục lục')) {
                        $(this).remove();
                    }
                });
            }
        });
    </script>
</body>
</html>
