---
layout: null
permalink: /ebook-kiem-phi.html
---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ebook - Kiếm Phi Vạn Nhân Địch</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Niramit:wght@400;500&family=Times+New+Roman&display=swap" rel="stylesheet">
    <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css' rel='stylesheet'/>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js'></script>

    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        #status-area { margin-top: 50px; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #d35400; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn-download {
            background-color: #27ae60; color: white; padding: 15px 30px; 
            border: none; border-radius: 5px; font-size: 18px; cursor: pointer; 
            text-decoration: none; font-weight: bold; display: none; /* Ẩn nút lúc đầu */
        }
        .btn-download:hover { background-color: #219150; }

        /* CSS này chỉ dùng để tải nội dung, không hiển thị ra */
        #hidden-content { display: none; }
    </style>
</head>
<body>

    <div id="status-area">
        <div class="loader" id="spinner"></div>
        <h2 id="loading-text">Đang tập hợp dữ liệu các chương...</h2>
        <p id="progress-text">Vui lòng đợi...</p>
        
        <button id="btn-export" class="btn-download" onclick="exportToWordFile()">
            <i class="fas fa-file-word"></i> TẢI FILE CHO WORD (ĐÃ XỬ LÝ LINK)
        </button>
    </div>

    <div id="hidden-content"></div>

    <script>
        // CẤU HÌNH LINK GỐC
        var tocUrl = "/stories/kiem-phi-van-nhan-dich.html"; 
        var finalContent = ""; // Biến chứa toàn bộ nội dung sạch

        $(document).ready(function() {
            var linksToFetch = [];

            // B1: Lấy danh sách chương
            $('<div>').load(tocUrl + ' #chapter-list-container', function(response, status, xhr) {
                if (status == "error") {
                    $('#loading-text').text("Lỗi! Không tìm thấy mục lục.");
                    $('#spinner').hide();
                    return;
                }
                
                $(this).find('a').each(function() {
                    var href = $(this).attr('href');
                    var text = $(this).text();
                    if(href && !href.includes('LINK-CHƯƠNG')) {
                        linksToFetch.push({ url: href, title: text });
                    }
                });

                if(linksToFetch.length === 0) { $('#loading-text').text("Chưa có chương nào."); return; }
                
                $('#loading-text').text("Tìm thấy " + linksToFetch.length + " chương. Đang xử lý...");
                
                // BẮT ĐẦU TẠO NỘI DUNG CHO WORD
                buildWordContent(linksToFetch);
            });
        });

        function buildWordContent(chapters) {
            // 1. TẠO PHẦN BÌA
            finalContent += `
                <div class='Section1' style='text-align:center; margin-bottom: 50px; page-break-after: always;'>
                    <h1 style='font-size:36pt; color:#000; font-family:"Times New Roman"; margin-top:100px;'>KIẾM PHI VẠN NHÂN ĐỊCH</h1>
                    <p style='font-size:18pt; font-style:italic;'>Tác giả: Cơ Giới Điểu | Editor: Mẫn Nhược</p>
                    <p style='font-size:14pt;'>CP: Triệu Mẫn x Chu Chỉ Nhược</p>
                    <br/><br/>
                    <h2 style='color:#000;'>MỤC LỤC</h2>
            `;

            // 2. TẠO LINK MỤC LỤC (Dùng Anchor Name cổ điển cho Word dễ hiểu)
            chapters.forEach(function(chap, index) {
                finalContent += `<p><a href="#chap${index}" style="color:blue; text-decoration:none; font-size:14pt;">${chap.title}</a></p>`;
            });
            finalContent += "</div>"; // Hết trang bìa

            // 3. TẢI TỪNG CHƯƠNG
            loadChapterContent(chapters, 0);
        }

        function loadChapterContent(chapters, index) {
            if (index >= chapters.length) {
                // HOÀN TẤT
                $('#spinner').hide();
                $('#loading-text').text("Đã xử lý xong! Hãy bấm nút bên dưới.");
                $('#progress-text').hide();
                $('#btn-export').show(); // Hiện nút tải
                return;
            }

            var chap = chapters[index];
            $('#progress-text').text("Đang xử lý: " + chap.title);

            $('<div>').load(chap.url + ' .post-body', function(response, status) {
                if (status == "success") {
                    var contentHTML = $(this).find('.post-body').html() || $(this).find('.entry-content').html();
                    
                    // XỬ LÝ NỘI DUNG TRƯỚC KHI LƯU
                    var $temp = $('<div>').html(contentHTML);
                    
                    // a. Xóa rác
                    $temp.find('p, div').each(function() {
                        var t = $(this).text().toLowerCase();
                        if ((t.includes("chương trước") || t.includes("chương sau") || t.includes("mục lục")) && t.length < 200) $(this).remove();
                        if (t.includes("đọc tại") || t.includes("re-up")) $(this).remove();
                    });
                    $temp.find('a').each(function() {
                       if($(this).text().toLowerCase().includes('chương')) $(this).remove(); 
                    });

                    // b. Xử lý tiêu đề đẹp (Chuyển thành style inline cho Word)
                    var headerStyle = "font-family:'Arial Black', sans-serif; color:#d8a011; text-transform:uppercase; text-align:center; font-size:24pt; margin-top:30px;";
                    
                    // c. Xử lý Chú thích (Chuyển thành link nội bộ #note / #ref)
                    var noteList = "";
                    var noteCount = 0;
                    $temp.find('.tooltip').each(function() {
                        noteCount++;
                        var tooltipText = $(this).find('.tooltiptext').html();
                        var refId = `ref_${index}_${noteCount}`;
                        var noteId = `note_${index}_${noteCount}`;
                        
                        // Tạo số mũ bấm được
                        $(this).replaceWith(`<a name="${refId}"></a><a href="#${noteId}" style="color:blue; font-weight:bold; font-size:10pt; vertical-align:super;">[${noteCount}]</a>`);
                        
                        // Tạo nội dung ở cuối
                        noteList += `<p style="margin-bottom:10px;"><a name="${noteId}"></a><a href="#${refId}" style="font-weight:bold; text-decoration:none; color:blue;">[${noteCount}]</a> ${tooltipText}</p>`;
                    });

                    // d. Gom lại thành HTML string
                    // Thêm <a name="chapX"> để mục lục nhảy tới đúng chỗ
                    finalContent += `<div style="page-break-after:always;">
                        <a name="chap${index}"></a>
                        <h1 style="${headerStyle}">${chap.title}</h1>
                        <div style="font-family:'Times New Roman', serif; font-size:14pt; text-align:justify; line-height:1.5;">
                            ${$temp.html()}
                        </div>`;
                    
                    if(noteCount > 0) {
                        finalContent += `<hr/><div style="margin-top:30px; font-family:Arial, sans-serif; font-size:11pt;">
                            <h4>CHÚ THÍCH:</h4>
                            ${noteList}
                        </div>`;
                    }
                    
                    finalContent += `</div>`;
                }
                loadChapterContent(chapters, index + 1);
            });
        }

        // HÀM XUẤT FILE DOC
        function exportToWordFile() {
            var header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                         "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                         "xmlns='http://www.w3.org/TR/REC-html40'>"+
                         "<head><meta charset='utf-8'><title>Export HTML to Word Document with JavaScript</title></head><body>";
            var footer = "</body></html>";
            var sourceHTML = header + finalContent + footer;
            
            var source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            var fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = 'Kiem-Phi-Van-Nhan-Dich-Full.doc'; // Lưu thẳng thành .doc để Word mở chuẩn
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }
    </script>
</body>
</html>
